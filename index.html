<!DOCTYPE html>
<html lang="zh" class="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Prompt æœç´¢æ•°æ®åº“</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','sans-serif'] },
          colors: { primary:'#4f46e5', secondary:'#8b5cf6', 'bg-dark':'#1f2937', 'card-light':'#374151' }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    body{ background:transparent; min-height:100vh; display:flex; justify-content:center; align-items:flex-start; padding:2rem 1rem; position:relative; overflow-x:hidden; }

    /* ===== èƒŒæ™¯å±‚ï¼ˆæ¸å˜+æ ¼çº¹+æµä½“ blobï¼‰ ===== */
    #bg-layer{ position:fixed; inset:0; z-index:0; pointer-events:none; }
    .bg-gradient{ position:absolute; inset:0;
      background:
        radial-gradient(1200px 800px at 10% 5%, rgba(238,242,255,1) 0%, rgba(238,242,255,0) 40%),
        radial-gradient(900px 700px at 85% 15%, rgba(254,226,226,1) 0%, rgba(254,226,226,0) 45%),
        radial-gradient(900px 700px at 20% 85%, rgba(220,252,231,1) 0%, rgba(220,252,231,0) 40%),
        linear-gradient(180deg, #ffffff 0%, #f7f7fb 60%, #f3f4f6 100%);
    }
    .dark .bg-gradient{
      background:
        radial-gradient(1200px 800px at 10% 5%, rgba(31,41,55,1) 0%, rgba(31,41,55,0) 35%),
        radial-gradient(900px 700px at 85% 15%, rgba(55,48,163,0.35) 0%, rgba(55,48,163,0) 45%),
        radial-gradient(900px 700px at 20% 85%, rgba(16,185,129,0.25) 0%, rgba(16,185,129,0) 40%),
        linear-gradient(180deg, #0b1220 0%, #0f172a 45%, #111827 100%);
    }
    .bg-grid{ position:absolute; inset:0; background-image:
      linear-gradient(to right, rgba(0,0,0,.06) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(0,0,0,.06) 1px, transparent 1px);
      background-size:28px 28px; opacity:.25; mix-blend-mode:multiply;
    }
    .dark .bg-grid{ background-image:
      linear-gradient(to right, rgba(255,255,255,.08) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(255,255,255,.08) 1px, transparent 1px);
      opacity:.2; mix-blend-mode:screen;
    }
    .blob{ position:absolute; width:38vw; height:38vw; max-width:680px; max-height:680px; border-radius:50%;
      filter:blur(40px); opacity:.7; mix-blend-mode:multiply; animation:blobFloat 16s ease-in-out infinite alternate;
    }
    .blob-1{ top:-8vh; left:-10vw; background:radial-gradient(circle at 30% 30%, #a78bfa, #60a5fa); animation-delay:0s; }
    .blob-2{ top:20vh; right:-12vw; background:radial-gradient(circle at 60% 40%, #f59e0b, #f43f5e); animation-delay:.6s; }
    .blob-3{ bottom:-10vh; left:20vw; background:radial-gradient(circle at 50% 50%, #34d399, #22d3ee); animation-delay:1.2s; }
    @keyframes blobFloat{ 0%{ transform:translate3d(0,0,0) scale(1);} 100%{ transform:translate3d(3vw,-2vh,0) scale(1.06);} }

    /* ===== å°é»„è±†å‰ç¥¥ç‰©ï¼ˆåŠ¨ç”»å›å½’ï¼‰ ===== */
    #mascot-layer{ position:fixed; inset:0; z-index:1; pointer-events:none; }
    .mascot{ position:absolute; width:56px; height:72px; pointer-events:none; animation: driftX linear infinite; will-change: transform; }
    @keyframes driftX{ 0%{ transform: translate3d(-12vw,0,0) } 100%{ transform: translate3d(112vw,0,0) } }
    .mascot .body{ position:absolute; inset:0; background:#F6D84C; border-radius:28px 28px 22px 22px; box-shadow:inset 0 -8px 0 rgba(0,0,0,.06); }
    .mascot .strap{ position:absolute; left:-6px; right:-6px; top:30px; height:8px; background:#111827; opacity:.9; border-radius:6px; }
    .mascot .goggle{ position:absolute; top:16px; left:50%; transform:translateX(-50%); width:34px; height:34px; border-radius:50%; border:5px solid #9CA3AF; background:#fff; overflow:hidden; }
    .mascot .pupil{ position:absolute; top:50%; left:50%; width:10px; height:10px; background:#1f2937; border-radius:50%; transform:translate(-50%,-50%); animation: look 4s ease-in-out infinite; }
    @keyframes look{ 0%,100%{transform:translate(-50%,-50%)} 25%{transform:translate(-35%,-50%)} 50%{transform:translate(-50%,-35%)} 75%{transform:translate(-65%,-50%)} }
    .mascot .eyelid{ position:absolute; left:0; right:0; top:0; height:0%; background:#F6D84C; z-index:2; animation: blink 5s infinite; }
    @keyframes blink{ 0%,92%,100%{height:0%} 94%{height:100%} 96%{height:0%} }
    .mascot .hem{ position:absolute; left:0; right:0; bottom:0; height:26px; background:#2563EB; border-bottom-left-radius:14px; border-bottom-right-radius:14px; }
    @media (prefers-reduced-motion: reduce){ .blob,.mascot{ animation:none!important; } }

    /* ===== åˆ—è¡¨/å¡ç‰‡/UI ===== */
    .custom-scroll::-webkit-scrollbar{ width:8px; } .custom-scroll::-webkit-scrollbar-thumb{ background:#9ca3af; border-radius:4px; } .custom-scroll::-webkit-scrollbar-track{ background:#e5e7eb; }
    input:focus,textarea:focus,button:focus{ outline:none; box-shadow:0 0 0 3px rgba(79,70,229,.35); }
    #prompt-list-container{ display:flex; flex-wrap:wrap; gap:1rem; align-content:flex-start; min-height:200px; position:relative; z-index:2; }
    .prompt-card{
      width:260px; height:160px; background:rgba(255,255,255,.78); backdrop-filter:blur(12px);
      border:1px solid rgba(255,255,255,.35); border-radius:1rem; box-shadow:0 6px 18px rgba(0,0,0,.08);
      padding:1rem 1.2rem; display:flex; flex-direction:column; justify-content:space-between; cursor:grab;
      transition:transform .25s ease, box-shadow .25s ease, border-color .25s ease; user-select:none;
    }
    .prompt-card:hover{ transform:translateY(-6px) scale(1.02); box-shadow:0 12px 30px rgba(79,70,229,.25); border-color:rgba(79,70,229,.35); }
    .prompt-card.dragging{ opacity:.55; transform:scale(.98); cursor:grabbing; }
    .prompt-title{ font-size:1.1rem; font-weight:700; color:#111827; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .prompt-date{ font-size:.75rem; color:#6b7280; text-align:right; }

    .modal{ position:fixed; inset:0; background:rgba(17,24,39,.45); display:flex; justify-content:center; align-items:center; z-index:100; backdrop-filter:blur(6px); opacity:0; transition:opacity .25s ease; }
    .modal.show{ opacity:1; }
    .modal-content{ background:#fff; padding:1.5rem 2rem; border-radius:1rem; box-shadow:0 10px 25px rgba(0,0,0,.2); width:90%; max-width:720px; position:relative; transform:scale(.9); transition:transform .22s ease, opacity .22s ease; opacity:0; }
    .modal.show .modal-content{ transform:scale(1); opacity:1; }
    .detail-content-box{ white-space:pre-wrap; word-break:break-word; max-height:60vh; overflow-y:auto; }

    #toast{ position:fixed; bottom:40px; left:50%; transform:translateX(-50%) translateY(10px); background:rgba(55,65,81,.6); backdrop-filter:blur(8px); color:#fff; padding:.9rem 1.6rem; border-radius:9999px; font-size:.9rem; box-shadow:0 5px 15px rgba(0,0,0,.25); opacity:0; pointer-events:none; transition:all .45s ease; z-index:999; }
    #toast.show{ opacity:1; transform:translateX(-50%) translateY(-6px); }

    :root{ color-scheme: light dark; }
    html.dark, body.dark{ background-color:#111827; }
    .dark .bg-white{ background-color:rgba(31,41,55,.88)!important; color:#e5e7eb; }
    .dark h1,.dark h2,.dark .text-gray-800{ color:#e5e7eb!important; }
    .dark .text-gray-700{ color:#d1d5db!important; }
    .dark input,.dark textarea{ background:rgba(31,41,55,.7); color:#e5e7eb; border-color:rgba(255,255,255,.15); }
    .dark .prompt-card{ background:rgba(31,41,55,.72); color:#e5e7eb; border:1px solid rgba(255,255,255,.12); box-shadow:0 0 12px rgba(255,255,255,.06); }
    .dark .prompt-title{ color:#f3f4f6; } .dark .prompt-date{ color:#9ca3af; }
    .dark .modal-content{ background:rgba(31,41,55,.95); color:#f3f4f6; }
    .dark #toast{ background:rgba(243,244,246,.1); }

    /* ===== é¡¹ç›®ä¾§æ ï¼ˆæ‹–æ‹½ç›®æ ‡ï¼‰ ===== */
    .project-item{ display:flex; align-items:center; justify-content:space-between; padding:.6rem .8rem; border-radius:.8rem; border:1px dashed rgba(0,0,0,.08); background:rgba(255,255,255,.6); transition:background .2s ease, border-color .2s ease, transform .15s ease; }
    .project-item:hover{ background:rgba(255,255,255,.9); }
    .project-item.active{ border-style:solid; border-color:rgba(79,70,229,.5); box-shadow:0 8px 18px rgba(79,70,229,.12); }
    .project-item.drop-target{ background:rgba(79,70,229,.08); border-color:rgba(79,70,229,.6); transform:scale(1.01); }
    .dark .project-item{ background:rgba(31,41,55,.55); border-color:rgba(255,255,255,.12); }
    .dark .project-item:hover{ background:rgba(31,41,55,.85); }
    .dark .project-item.drop-target{ background:rgba(139,92,246,.15); border-color:rgba(139,92,246,.6); }

    /* ===== è´¦å·å¾½ç« ï¼ˆæ¸å˜è‰²ï¼Œéå¤§çº¢ï¼‰ ===== */
    .id-badge{ display:inline-flex; align-items:center; gap:.5rem; padding:.35rem .7rem; border-radius:9999px; font-weight:600;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%); color:#fff; box-shadow:0 6px 16px rgba(99,102,241,.25); }
    .id-edit-btn{ font-size:.75rem; padding:.25rem .5rem; border-radius:.6rem; background:rgba(255,255,255,.2); color:#fff; }
    .id-edit-btn:hover{ background:rgba(255,255,255,.32); }

    .app-grid{ display:grid; grid-template-columns:1fr; gap:1rem; }
    @media (min-width:1024px){ .app-grid{ grid-template-columns:280px 1fr; } }
  </style>
</head>
<body class="bg-transparent">

  <!-- èƒŒæ™¯ -->
  <div id="bg-layer" aria-hidden="true">
    <div class="bg-gradient"></div>
    <div class="bg-grid"></div>
    <div class="blob blob-1"></div><div class="blob blob-2"></div><div class="blob blob-3"></div>
  </div>
  <!-- å‰ç¥¥ç‰©å±‚ï¼ˆâœ… æ¢å¤åŠ¨ç”»ï¼‰ -->
  <div id="mascot-layer" aria-hidden="true"></div>

  <div id="app-container" class="w-full max-w-6xl space-y-4 relative z-10">
    <h1 class="text-4xl font-bold text-center text-gray-800">æˆ‘çš„ Prompt çŸ¥è¯†åº“</h1>

    <!-- é¡¶éƒ¨ï¼šä¸»é¢˜åˆ‡æ¢ + è´¦å·ä¿¡æ¯ -->
    <div class="flex flex-col sm:flex-row items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <button id="theme-toggle"
          class="py-2 px-4 bg-gray-200 text-gray-800 rounded-xl transition-all duration-300 shadow-sm hover:shadow-md text-sm font-medium">
          ğŸŒ åˆ‡æ¢æš—è‰²æ¨¡å¼
        </button>
      </div>

      <div class="flex items-center gap-3">
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-600">å½“å‰èº«ä»½ï¼š</span>
          <span id="display-id-badge" class="id-badge">æœªç™»å½•</span>
          <button id="edit-id-btn" class="id-edit-btn hidden">ç¼–è¾‘ID</button>
        </div>
        <button id="auth-button"
          class="py-2 px-4 bg-secondary text-white font-semibold rounded-xl hover:bg-purple-700 transition duration-300 shadow-md text-sm">
          ç™»å½• / æ³¨å†Œ
        </button>
      </div>
    </div>

    <!-- é”™è¯¯æç¤º -->
    <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl" role="alert">
      <strong class="font-bold">é”™è¯¯:</strong>
      <span id="error-text" class="block sm:inline"></span>
    </div>

    <!-- ä¸»å¸ƒå±€ï¼šé¡¹ç›®ä¾§æ  + ä¸»å†…å®¹ -->
    <div class="app-grid">
      <!-- å·¦ï¼šé¡¹ç›®ä¾§æ  -->
      <aside class="bg-white dark:bg-opacity-60 p-5 shadow-xl rounded-2xl border border-gray-200 dark:border-white/10">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold text-gray-700">é¡¹ç›®</h2>
        </div>

        <form id="create-project-form" class="flex gap-2 mb-4">
          <input id="project-name-input" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary"
                 placeholder="æ–°é¡¹ç›®åç§°ï¼ˆæ— é™åˆ¶ï¼‰" />
          <button class="px-3 py-2 bg-primary text-white rounded-lg hover:bg-indigo-700">åˆ›å»º</button>
        </form>

        <div class="space-y-2">
          <div class="project-item active" data-id="all">
            <span>å…¨éƒ¨</span>
            <span id="count-all" class="text-xs text-gray-500">0</span>
          </div>
          <div class="project-item" data-id="unassigned">
            <span>æœªå½’æ¡£</span>
            <span id="count-unassigned" class="text-xs text-gray-500">0</span>
          </div>
          <div id="projects-list" class="space-y-2 mt-2"></div>
        </div>
      </aside>

      <!-- å³ï¼šä¸»å†…å®¹ -->
      <main class="space-y-6">
        <!-- æ·»åŠ  Prompt -->
        <div class="bg-white p-6 md:p-8 shadow-xl rounded-2xl border border-gray-200 dark:border-white/10">
          <h2 class="text-2xl font-semibold text-gray-700 mb-4">æ·»åŠ æ–°çš„ Prompt</h2>
          <form id="add-prompt-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" for="prompt-title">æ ‡é¢˜</label>
              <input id="prompt-title" required class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-primary focus:border-primary" placeholder="è¾“å…¥ç®€çŸ­çš„æ ‡é¢˜">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" for="prompt-tags">æ ‡ç­¾ (é€—å·åˆ†éš”)</label>
              <input id="prompt-tags" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-primary focus:border-primary" placeholder="ä¾‹å¦‚: ç§‘æŠ€, æ—…æ¸¸, æ€»ç»“">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" for="prompt-content">Prompt å†…å®¹</label>
              <textarea id="prompt-content" rows="4" required class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-primary focus:border-primary" placeholder="è¾“å…¥å®Œæ•´çš„ Prompt æ–‡æœ¬..."></textarea>
            </div>
            <button id="add-prompt-btn" class="w-full py-2 px-4 bg-primary text-white font-semibold rounded-xl hover:bg-indigo-700 transition duration-300 shadow-md">
              <span id="btn-text">ä¿å­˜ Prompt</span>
              <span id="btn-loading" class="hidden">ä¿å­˜ä¸­...</span>
            </button>
          </form>
        </div>

        <!-- æœç´¢ + åˆ—è¡¨ -->
        <div class="space-y-6">
          <div class="bg-white p-6 md:p-8 shadow-xl rounded-2xl border border-gray-200 dark:border-white/10">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">æœç´¢ Prompt</h2>
            <input id="search-input" placeholder="è¾“å…¥å…³é”®è¯æœç´¢ (æ ‡é¢˜, å†…å®¹æˆ–æ ‡ç­¾)..." class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-primary focus:border-primary">
          </div>

          <div id="prompt-list-container" class="min-h-[200px]">
            <p id="loading-indicator" class="text-gray-500">åŠ è½½ä¸­...</p>
          </div>
          <p id="no-results" class="hidden text-center text-gray-500 mt-2">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ Promptã€‚</p>
        </div>
      </main>
    </div>
  </div>

  <!-- ç™»å½•/æ³¨å†Œ Modal -->
  <div id="auth-modal" class="modal hidden">
    <div id="auth-modal-content" class="modal-content">
      <h2 id="modal-title" class="text-2xl font-semibold text-gray-700 mb-4 text-center">ç”¨æˆ·ç™»å½•</h2>
      <form id="auth-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" for="email">é‚®ç®±åœ°å€</label>
          <input id="email" type="email" required class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-primary focus:border-primary" placeholder="è¾“å…¥é‚®ç®±">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" for="password">å¯†ç </label>
          <input id="password" type="password" required class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-primary focus:border-primary" placeholder="è¾“å…¥å¯†ç  (è‡³å°‘6ä½)">
        </div>
        <button id="modal-submit-btn" class="w-full py-2 px-4 bg-primary text-white font-semibold rounded-xl hover:bg-indigo-700 transition duration-300 shadow-md">ç™»å½•</button>
      </form>
      <button id="toggle-mode-btn" class="w-full mt-3 text-sm text-primary hover:text-indigo-700 font-medium">åˆ‡æ¢åˆ°æ³¨å†Œæ¨¡å¼</button>
      <button id="close-auth-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
  </div>

  <!-- è¯¦æƒ… Modal -->
  <div id="detail-modal" class="modal hidden">
    <div id="detail-modal-content" class="modal-content">
      <h2 id="detail-title" class="text-2xl font-bold text-gray-800 mb-3">Prompt æ ‡é¢˜</h2>
      <div id="detail-tags" class="flex flex-wrap gap-2 mb-2"></div>
      <div id="detail-content" class="detail-content-box custom-scroll bg-gray-50 p-4 rounded-xl text-gray-700 text-sm border border-gray-200">å®Œæ•´çš„ Prompt å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</div>
      <div class="flex justify-between items-center mt-4">
        <div id="detail-date" class="text-xs text-gray-400"></div>
        <div class="flex gap-2">
          <button id="detail-copy-btn" class="py-2 px-4 bg-primary text-white font-semibold rounded-xl hover:bg-indigo-700 transition duration-300 shadow-md text-sm">å¤åˆ¶å®Œæ•´ Prompt</button>
          <button id="detail-delete-btn" class="py-2 px-4 bg-red-500 text-white font-semibold rounded-xl hover:bg-red-600 transition duration-300 shadow-md text-sm">åˆ é™¤</button>
          <button id="close-detail-modal-btn" class="py-2 px-4 bg-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-400 transition duration-300 text-sm">å…³é—­</button>
        </div>
      </div>
      <button id="close-detail-modal-icon" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
  </div>

  <!-- ç¼–è¾‘ID Modal -->
  <div id="id-modal" class="modal hidden">
    <div class="modal-content">
      <h2 class="text-xl font-semibold mb-3">è®¾ç½®æˆ‘çš„ ID</h2>
      <p class="text-sm text-gray-500 mb-3">æ­¤ ID ä»…ç”¨äºæ˜¾ç¤ºï¼ˆä¸ä¼šæš´éœ²é‚®ç®±ï¼‰ï¼Œæ”¯æŒä¸­è‹±æ–‡ä¸æ•°å­—ä¸‹åˆ’çº¿ã€‚</p>
      <form id="id-form" class="flex gap-2">
        <input id="id-input" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="ä¾‹å¦‚ï¼šTaylor æˆ– ä¹æ’_Taylor">
        <button class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-indigo-700">ä¿å­˜</button>
      </form>
      <button id="close-id-modal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp,
      doc, deleteDoc, setDoc, getDoc, updateDoc, deleteField
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    /* ===== å…¨å±€çŠ¶æ€ ===== */
    let db, auth, userId=null, isEmailSignedIn=false, authMode='login';
    let allPrompts=[], allProjects=[], unsubscribePrompts=null, unsubscribeProjects=null, selectedProjectId='all', currentDetailId=null;

    /* ===== Firebase é…ç½®ï¼ˆæ²¿ç”¨ä½ åŸæ–‡ä»¶ï¼‰ ===== */
    const YOUR_FIREBASE_CONFIG = {
      apiKey:"AIzaSyBePfEThajXkfixYc-oUl9m8htKcXRuuI8",
      authDomain:"prompt-29d34.firebaseapp.com",
      projectId:"prompt-29d34",
      storageBucket:"prompt-29d34.firebasestorage.app",
      messagingSenderId:"2282413195",
      appId:"1:2282413195:web:1ecae5e1a116be239b488e",
      measurementId:"G-R7TW7M0L5M"
    };
    const appId="default-standalone-app";
    const firebaseConfig = (typeof __firebase_config!=='undefined' && Object.keys(JSON.parse(__firebase_config)).length>0)
      ? JSON.parse(__firebase_config) : YOUR_FIREBASE_CONFIG;
    const initialAuthToken = (typeof __initial_auth_token!=='undefined') ? __initial_auth_token : null;

    /* ===== DOM ===== */
    const errorEl=document.getElementById('error-message');
    const errorTextEl=document.getElementById('error-text');
    const authButton=document.getElementById('auth-button');
    const themeToggle=document.getElementById('theme-toggle');

    const displayIdBadge=document.getElementById('display-id-badge');
    const editIdBtn=document.getElementById('edit-id-btn');
    const idModal=document.getElementById('id-modal');
    const idInput=document.getElementById('id-input');
    const idForm=document.getElementById('id-form');
    const closeIdModal=document.getElementById('close-id-modal');

    const createProjectForm=document.getElementById('create-project-form');
    const projectNameInput=document.getElementById('project-name-input');
    const projectsListEl=document.getElementById('projects-list');
    const countAllEl=document.getElementById('count-all');
    const countUnassignedEl=document.getElementById('count-unassigned');

    const promptListContainer=document.getElementById('prompt-list-container');
    const loadingIndicatorEl=document.getElementById('loading-indicator');
    const noResultsEl=document.getElementById('no-results');
    const addPromptForm=document.getElementById('add-prompt-form');
    const addPromptBtn=document.getElementById('add-prompt-btn');
    const btnText=document.getElementById('btn-text');
    const btnLoading=document.getElementById('btn-loading');
    const searchInput=document.getElementById('search-input');

    const authModal=document.getElementById('auth-modal');
    const authForm=document.getElementById('auth-form');
    const modalTitle=document.getElementById('modal-title');
    const modalSubmitBtn=document.getElementById('modal-submit-btn');
    const toggleModeBtn=document.getElementById('toggle-mode-btn');
    const closeModalBtn=document.getElementById('close-auth-modal-btn');
    const emailInput=document.getElementById('email');
    const passwordInput=document.getElementById('password');

    const detailModal=document.getElementById('detail-modal');
    const detailTitle=document.getElementById('detail-title');
    const detailTags=document.getElementById('detail-tags');
    const detailContent=document.getElementById('detail-content');
    const detailCopyBtn=document.getElementById('detail-copy-btn');
    const detailDeleteBtn=document.getElementById('detail-delete-btn');
    const closeDetailModalBtn=document.getElementById('close-detail-modal-btn');
    const closeDetailModalIcon=document.getElementById('close-detail-modal-icon');
    const detailDate=document.getElementById('detail-date');

    const toastEl=document.getElementById('toast');

    /* ===== å·¥å…·å‡½æ•° ===== */
    function showError(msg){ errorTextEl.textContent=msg; errorEl.classList.remove('hidden'); loadingIndicatorEl.textContent='åŠ è½½å¤±è´¥ã€‚'; }
    function showToast(msg){ toastEl.textContent=msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),1800); }

    // ä¸»é¢˜
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    function applyTheme(){
      const saved=localStorage.getItem('theme'); const isDark=saved? saved==='dark' : prefersDark;
      document.documentElement.classList.toggle('dark', isDark); document.body.classList.toggle('dark', isDark);
      themeToggle.textContent = isDark? 'ğŸŒ™ åˆ‡æ¢äº®è‰²æ¨¡å¼' : 'ğŸŒ åˆ‡æ¢æš—è‰²æ¨¡å¼';
    }
    applyTheme();
    themeToggle.addEventListener('click', ()=>{
      const willDark = !document.documentElement.classList.contains('dark');
      document.documentElement.classList.toggle('dark', willDark); document.body.classList.toggle('dark', willDark);
      themeToggle.textContent = willDark? 'ğŸŒ™ åˆ‡æ¢äº®è‰²æ¨¡å¼' : 'ğŸŒ åˆ‡æ¢æš—è‰²æ¨¡å¼'; localStorage.setItem('theme', willDark?'dark':'light');
    });

    /* ===== å‰ç¥¥ç‰©ç”Ÿæˆï¼ˆæ¢å¤åŠ¨ç”»ï¼‰ ===== */
    function spawnMascots(n=3){
      const layer=document.getElementById('mascot-layer');
      if(!layer) return;
      layer.innerHTML='';
      for(let i=0;i<n;i++){
        const m=document.createElement('div'); m.className='mascot';
        const baseY = 60 + Math.random()*120;
        const duration = 22 + Math.random()*12;
        const delay = Math.random()*-duration;
        m.style.bottom = baseY + 'px';
        m.style.animationDuration = duration + 's';
        m.style.animationDelay = delay + 's';
        m.innerHTML = `
          <div class="body"></div>
          <div class="strap"></div>
          <div class="goggle">
            <div class="eyelid"></div>
            <div class="pupil"></div>
          </div>
          <div class="hem"></div>
        `;
        layer.appendChild(m);
      }
    }

    /* ===== Firestore è·¯å¾„ï¼ˆé‡è¦ä¿®å¤ï¼‰ =====
       - ç”¨æˆ·æ ¹æ–‡æ¡£ï¼šartifacts/{appId}/users/{userId}   âœ… æ–‡æ¡£è·¯å¾„ï¼ˆå¶æ•°æ®µï¼‰
       - å­é›†åˆï¼šprompts / projects                     âœ… é›†åˆè·¯å¾„
    */
    const userDocPath     = () => userId ? `artifacts/${appId}/users/${userId}` : null;
    const colPromptsPath  = () => userId ? `artifacts/${appId}/users/${userId}/prompts` : null;
    const colProjectsPath = () => userId ? `artifacts/${appId}/users/${userId}/projects` : null;

    /* ===== è´¦å·IDï¼ˆdisplayIdï¼‰ ===== */
    async function loadOrInitDisplayId(){
      const p = userDocPath(); if(!p) return;
      const ref = doc(db, p); // âœ… æ–‡æ¡£è·¯å¾„ï¼Œåˆæ³•
      let displayId = '';
      try{
        const snap = await getDoc(ref);
        if(snap.exists()){
          displayId = snap.data().displayId || '';
        }else{
          const fallback = (isEmailSignedIn && auth.currentUser?.email)
            ? auth.currentUser.email.split('@')[0]
            : 'User-'+(userId? userId.slice(-6): Math.random().toString(36).slice(-6));
          await setDoc(ref, { displayId: fallback, updatedAt: serverTimestamp() }, { merge:true });
          displayId = fallback;
        }
        renderDisplayId(displayId);
      }catch(err){ console.error('åŠ è½½IDå¤±è´¥:', err); showToast('âš ï¸ è¯»å–æ˜¾ç¤ºIDå¤±è´¥'); }
    }
    function renderDisplayId(id){ document.getElementById('display-id-badge').textContent = id || 'æœªç™»å½•'; }
    function openIdModal(){ idInput.value = document.getElementById('display-id-badge').textContent==='æœªç™»å½•' ? '' : document.getElementById('display-id-badge').textContent; idModal.classList.remove('hidden'); requestAnimationFrame(()=>idModal.classList.add('show')); }
    function closeId(){ idModal.classList.remove('show'); setTimeout(()=>idModal.classList.add('hidden'),200); }
    document.getElementById('id-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const val = idInput.value.trim(); if(!val){ showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„ ID'); return; }
      const p = userDocPath(); if(!p){ showToast('è¯·å…ˆç™»å½•'); return; }
      try{ await setDoc(doc(db, p), { displayId: val, updatedAt: serverTimestamp() }, { merge:true }); renderDisplayId(val); showToast('âœ… å·²æ›´æ–° ID'); closeId(); }
      catch(err){ console.error(err); showToast('âŒ æ›´æ–°å¤±è´¥'); }
    });
    document.getElementById('edit-id-btn').addEventListener('click', openIdModal);
    document.getElementById('close-id-modal').addEventListener('click', closeId);
    document.getElementById('id-modal').addEventListener('click', (e)=>{ if(e.target.id==='id-modal') closeId(); });

    /* ===== Auth UI ===== */
    function updateAuthUI(){
      if(isEmailSignedIn){
        authButton.textContent='é€€å‡ºç™»å½•';
        authButton.classList.remove('bg-secondary','hover:bg-purple-700');
        authButton.classList.add('bg-gray-700','hover:bg-gray-800');
        authButton.onclick=handleSignOut;
        document.getElementById('edit-id-btn').classList.remove('hidden');
      }else{
        authButton.textContent='ç™»å½• / æ³¨å†Œ';
        authButton.classList.remove('bg-gray-700','hover:bg-gray-800');
        authButton.classList.add('bg-secondary','hover:bg-purple-700');
        authButton.onclick=()=>{ authModal.classList.remove('hidden'); requestAnimationFrame(()=>authModal.classList.add('show')); };
        document.getElementById('edit-id-btn').classList.add('hidden');
      }
    }

    /* ===== Firebase åˆå§‹åŒ– ===== */
    async function initFirebase(){
      try{
        if(!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.includes('YOUR_API_KEY')){
          throw new Error('Firebase é…ç½®ç¼ºå¤±ã€‚è¯·å¡«å…¥çœŸå®é…ç½®ã€‚');
        }
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        onAuthStateChanged(auth, async (user)=>{
          if(user){
            userId = user.uid;
            isEmailSignedIn = user.providerData.some(p=>p.providerId==='password');
            updateAuthUI();
            spawnMascots(); // âœ… æ¢å¤åŠ¨ç”»ç”Ÿæˆ
            await loadOrInitDisplayId();
            watchProjects();
            watchPrompts();
          }else{
            try{ await signInAnonymously(auth); }
            catch(err){ console.error(err); showError('æ— æ³•å»ºç«‹åŒ¿åä¼šè¯'); renderPrompts([]); }
          }
        });
        if(initialAuthToken && !auth.currentUser){ await signInWithCustomToken(auth, initialAuthToken); }
      }catch(err){ console.error(err); showError('åº”ç”¨åˆå§‹åŒ–å¤±è´¥: '+err.message); }
    }

    /* ===== å®æ—¶ç›‘å¬ ===== */
    function watchProjects(){
      if(unsubscribeProjects) unsubscribeProjects();
      const path=colProjectsPath(); if(!path) return;
      unsubscribeProjects = onSnapshot(query(collection(db, path)), (snap)=>{
        allProjects = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        renderProjects();
      }, (err)=>console.error(err));
    }
    /* ===== é¡¹ç›®åˆ›å»º ===== */
    createProjectForm.addEventListener('submit', async (e) => {
      // 1. é˜»æ­¢è¡¨å•é»˜è®¤çš„é¡µé¢åˆ·æ–°è¡Œä¸º
      e.preventDefault();

      // 2. è·å–å¹¶æ¸…ç†ç”¨æˆ·è¾“å…¥çš„é¡¹ç›®åç§°
      const projectName = projectNameInput.value.trim();

      // 3. éªŒè¯ï¼šç¡®ä¿é¡¹ç›®åç§°ä¸ä¸ºç©º
      if (!projectName) {
        showToast('âš ï¸ é¡¹ç›®åç§°ä¸èƒ½ä¸ºç©ºï¼');
        return;
      }
      
      // 4. éªŒè¯ï¼šç¡®ä¿ç”¨æˆ·å·²ç™»å½•ï¼Œå¦åˆ™æ— æ³•å†™å…¥æ•°æ®åº“
      if (!userId) {
        showError('ç”¨æˆ·æœªè®¤è¯ï¼Œæ— æ³•åˆ›å»ºé¡¹ç›®ã€‚');
        return;
      }

      // 5. è°ƒç”¨ Firebase API å°†æ–°é¡¹ç›®æ·»åŠ åˆ°æ•°æ®åº“
      try {
        const path = colProjectsPath(); // è·å–é¡¹ç›®é›†åˆçš„è·¯å¾„
        if (!path) throw new Error('æ•°æ®åº“è·¯å¾„é”™è¯¯ï¼Œè¯·æ£€æŸ¥ç™»å½•çŠ¶æ€ã€‚');

        // å‘æ•°æ®åº“ä¸­æ·»åŠ ä¸€ä¸ªæ–°æ–‡æ¡£ï¼ˆå³æ–°é¡¹ç›®ï¼‰
        await addDoc(collection(db, path), {
          name: projectName,
          createdAt: serverTimestamp() // ä½¿ç”¨æœåŠ¡å™¨æ—¶é—´ï¼Œä¿è¯æ—¶é—´æˆ³çš„å‡†ç¡®æ€§
        });

        // 6. æ“ä½œæˆåŠŸåçš„å¤„ç†
        projectNameInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
        showToast('âœ… é¡¹ç›®å·²æˆåŠŸåˆ›å»ºï¼'); // æ˜¾ç¤ºæˆåŠŸæç¤º

      } catch (err) {
        // 7. é”™è¯¯å¤„ç†
        console.error("åˆ›å»ºé¡¹ç›®å¤±è´¥: ", err);
        showError('åˆ›å»ºé¡¹ç›®å¤±è´¥: ' + err.message);
      }
    });
    function watchPrompts(){
      if(unsubscribePrompts) unsubscribePrompts();
      const path=colPromptsPath(); if(!path) return;
      unsubscribePrompts = onSnapshot(query(collection(db, path)), (snap)=>{
        loadingIndicatorEl.classList.add('hidden');
        allPrompts = snap.docs.map(d=>({ id:d.id, ...d.data(), tags:d.data().tags||[] }));
        allPrompts.sort((a,b)=>(b.timestamp?.seconds||0)-(a.timestamp?.seconds||0));
        updateCounts();
        filterAndRenderPrompts(searchInput.value.toLowerCase());
      }, (err)=>{ console.error(err); showError('æ•°æ®å®æ—¶åŒæ­¥å¤±è´¥: '+err.message); });
    }

    /* ===== é¡¹ç›®æ¸²æŸ“ä¸äº¤äº’ ===== */
    function projectCount(id){
      if(id==='all') return allPrompts.length;
      if(id==='unassigned') return allPrompts.filter(p=>!p.projectId).length;
      return allPrompts.filter(p=>p.projectId===id).length;
    }
    function updateCounts(){
      countAllEl.textContent = projectCount('all');
      countUnassignedEl.textContent = projectCount('unassigned');
      document.querySelectorAll('[data-project-count]').forEach(el=>{
        const pid = el.getAttribute('data-project-count');
        el.textContent = projectCount(pid);
      });
    }
    function renderProjects(){
      projectsListEl.innerHTML='';
      allProjects.forEach(p=>{
        const li=document.createElement('div');
        li.className='project-item';
        li.setAttribute('data-id', p.id);
        li.innerHTML = `
          <span class="truncate">${p.name||'(æœªå‘½åé¡¹ç›®)'}</span>
          <span class="text-xs text-gray-500" data-project-count="${p.id}">${projectCount(p.id)}</span>
        `;
        li.addEventListener('click', ()=>selectProject(p.id));
        makeDropTarget(li, p.id);
        projectsListEl.appendChild(li);
      });
      // å›ºå®šå…¥å£ä¹Ÿå¯æ‹–æ‹½
      document.querySelectorAll('.project-item[data-id="all"], .project-item[data-id="unassigned"]').forEach(el=>{
        makeDropTarget(el, el.getAttribute('data-id'));
        el.addEventListener('click', ()=>selectProject(el.getAttribute('data-id')));
      });
      highlightActiveProject();
      updateCounts();
    }
    function selectProject(pid){
      selectedProjectId = pid;
      highlightActiveProject();
      filterAndRenderPrompts(searchInput.value.toLowerCase());
    }
    function highlightActiveProject(){
      document.querySelectorAll('.project-item').forEach(el=>{
        const id = el.getAttribute('data-id');
        el.classList.toggle('active', id===selectedProjectId);
      });
    }

    // æ‹–æ‹½ç›®æ ‡
    function makeDropTarget(el, targetId){
      el.addEventListener('dragover', (e)=>{ e.preventDefault(); el.classList.add('drop-target'); });
      el.addEventListener('dragleave', ()=> el.classList.remove('drop-target'));
      el.addEventListener('drop', async (e)=>{
        e.preventDefault(); el.classList.remove('drop-target');
        const promptId = e.dataTransfer.getData('text/plain');
        if(targetId==='all'){ showToast('â„¹ï¸ æ”¾åˆ°â€œå…¨éƒ¨â€ä¸ä¼šæ”¹å˜åˆ†ç±»'); return; }
        await movePromptToProject(promptId, targetId==='unassigned' ? null : targetId);
      });
    }

    async function movePromptToProject(promptId, projectId){
      try{
        const p=colPromptsPath(); if(!p) throw new Error('è·¯å¾„é”™è¯¯');
        const ref = doc(db, p, promptId);
        if(projectId){ await updateDoc(ref, { projectId }); showToast('ğŸ“¦ å·²ç§»åŠ¨åˆ°é¡¹ç›®'); }
        else { await updateDoc(ref, { projectId: deleteField() }); showToast('ğŸ—‚ï¸ å·²ç§»å‡ºé¡¹ç›®'); }
      }catch(err){ console.error(err); showToast('âŒ ç§»åŠ¨å¤±è´¥'); }
    }

    /* ===== åˆ—è¡¨ä¸è¿‡æ»¤ ===== */
    function renderPrompts(list){
      promptListContainer.innerHTML='';
      if(list.length===0){
        noResultsEl.classList.remove('hidden');
        if(allPrompts.length===0){
          promptListContainer.innerHTML='<p class="text-gray-500">æ•°æ®åº“ä¸­è¿˜æ²¡æœ‰ Promptã€‚è¯·ä½¿ç”¨ä¸Šæ–¹çš„è¡¨å•æ·»åŠ ç¬¬ä¸€ä¸ªï¼</p>';
        }
        return;
      }
      noResultsEl.classList.add('hidden');
      list.forEach(p=>{
        const card=document.createElement('div'); card.className='prompt-card'; card.setAttribute('draggable','true');
        const date = p.timestamp?.seconds ? new Date(p.timestamp.seconds*1000).toLocaleDateString('zh-CN') : '';
        card.innerHTML = `
          <div class="prompt-title" title="${p.title||''}">${p.title||''}</div>
          <div class="flex items-center justify-between text-xs text-gray-500">
            <span>${date}</span>
            ${p.projectId ? `<span class="px-2 py-0.5 rounded bg-gray-200 text-gray-600">é¡¹ç›®</span>` : `<span class="px-2 py-0.5 rounded bg-amber-100 text-amber-700">æœªå½’æ¡£</span>`}
          </div>
        `;
        // æ‰“å¼€è¯¦æƒ…
        card.addEventListener('click', (e)=>{ if(e.defaultPrevented) return; openDetailModal(p); });
        // æ‹–æ‹½
        card.addEventListener('dragstart', (e)=>{ card.classList.add('dragging'); e.dataTransfer.setData('text/plain', p.id); });
        card.addEventListener('dragend', ()=> card.classList.remove('dragging'));
        promptListContainer.appendChild(card);
      });
    }

    function filterAndRenderPrompts(term){
      term=(term||'').trim().toLowerCase();
      let data = allPrompts;

      // é¡¹ç›®è¿‡æ»¤
      if(selectedProjectId==='unassigned') data = data.filter(p=>!p.projectId);
      else if(selectedProjectId!=='all') data = data.filter(p=>p.projectId===selectedProjectId);

      // æœç´¢è¿‡æ»¤
      if(term){
        data = data.filter(p=>{
          const t=(p.title||'').toLowerCase(), c=(p.content||'').toLowerCase();
          const tagHit=(p.tags||[]).some(x=>(x||'').toLowerCase().includes(term));
          return t.includes(term) || c.includes(term) || tagHit;
        });
      }
      renderPrompts(data);
    }

    /* ===== CRUD ===== */
    addPromptForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!userId){ showError('ç”¨æˆ·æœªè®¤è¯ï¼Œæ— æ³•ä¿å­˜'); return; }
      const title=document.getElementById('prompt-title').value.trim();
      const tagsString=document.getElementById('prompt-tags').value.trim();
      const content=document.getElementById('prompt-content').value.trim();
      if(!title || !content){ showError('æ ‡é¢˜å’Œå†…å®¹éƒ½ä¸èƒ½ä¸ºç©ºã€‚'); return; }
      const tagsArray = tagsString? tagsString.split(',').map(t=>t.trim()).filter(Boolean): [];
      addPromptBtn.disabled=true; btnText.classList.add('hidden'); btnLoading.classList.remove('hidden');
      try{
        const p=colPromptsPath(); if(!p) throw new Error('è·¯å¾„é”™è¯¯');
        await addDoc(collection(db, p), { title, content, tags:tagsArray, timestamp: serverTimestamp() });
        addPromptForm.reset(); showToast('âœ… å·²ä¿å­˜ Prompt');
      }catch(err){ console.error(err); showError('ä¿å­˜å¤±è´¥: '+err.message); }
      finally{ addPromptBtn.disabled=false; btnText.classList.remove('hidden'); btnLoading.classList.add('hidden'); }
    });

    async function handleDeletePromptById(id){
      if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ª Prompt å—ï¼Ÿ')) return;
      if(!userId){ showToast('è¯·å…ˆç™»å½•'); return; }
      try{
        const p=colPromptsPath(); if(!p) throw new Error('è·¯å¾„é”™è¯¯');
        await deleteDoc(doc(db, p, id)); showToast('ğŸ—‘ï¸ å·²åˆ é™¤'); closeDetailModal();
      }catch(err){ console.error(err); showToast('âŒ åˆ é™¤å¤±è´¥'); }
    }

    /* ===== è¯¦æƒ…å¼¹çª— & å¤åˆ¶ ===== */
    function openDetailModal(prompt){
      currentDetailId = prompt.id || null;
      detailTitle.textContent = prompt.title || '(æœªå‘½å)';
      detailContent.textContent = prompt.content || '';
      detailCopyBtn.setAttribute('data-content', prompt.content || '');
      detailTags.innerHTML='';
      (prompt.tags||[]).forEach(tag=>{
        const el=document.createElement('span');
        el.className='px-3 py-1 bg-primary text-white text-xs font-medium rounded-full';
        el.textContent=tag; detailTags.appendChild(el);
      });
      const d=prompt.timestamp?.seconds ? new Date(prompt.timestamp.seconds*1000) : null;
      detailDate.textContent = d? d.toLocaleString('zh-CN') : '';
      detailModal.classList.remove('hidden'); requestAnimationFrame(()=>detailModal.classList.add('show'));
    }
    function closeDetailModal(){ detailModal.classList.remove('show'); setTimeout(()=>detailModal.classList.add('hidden'),200); }
    detailCopyBtn.addEventListener('click', async ()=>{ const c=detailCopyBtn.getAttribute('data-content')||''; try{ await navigator.clipboard.writeText(c); showToast('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'); }catch(e){ console.error(e); showToast('âŒ å¤åˆ¶å¤±è´¥'); } });
    detailDeleteBtn.addEventListener('click', ()=>{ if(currentDetailId) handleDeletePromptById(currentDetailId); });
    closeDetailModalBtn.addEventListener('click', closeDetailModal);
    closeDetailModalIcon.addEventListener('click', closeDetailModal);
    detailModal.addEventListener('click', (e)=>{ if(e.target===detailModal) closeDetailModal(); });

    /* ===== ç™»å½•/æ³¨å†Œ ===== */
    function toggleAuthMode(){
      authMode = authMode==='login'? 'register':'login';
      if(authMode==='login'){ modalTitle.textContent='ç”¨æˆ·ç™»å½•'; modalSubmitBtn.textContent='ç™»å½•'; toggleModeBtn.textContent='åˆ‡æ¢åˆ°æ³¨å†Œæ¨¡å¼'; }
      else { modalTitle.textContent='ç”¨æˆ·æ³¨å†Œ'; modalSubmitBtn.textContent='æ³¨å†Œ'; toggleModeBtn.textContent='åˆ‡æ¢åˆ°ç™»å½•æ¨¡å¼'; }
    }
    async function handleAuthSubmit(e){
      e.preventDefault();
      const email=emailInput.value.trim(), password=passwordInput.value.trim();
      if(password.length<6){ showError('å¯†ç è‡³å°‘6ä½'); return; }
      modalSubmitBtn.disabled=true; modalSubmitBtn.textContent = authMode==='login' ? 'ç™»å½•ä¸­...' : 'æ³¨å†Œä¸­...';
      errorEl.classList.add('hidden');
      try{
        await setPersistence(auth, browserLocalPersistence);
        if(authMode==='register'){ await createUserWithEmailAndPassword(auth, email, password); showToast('âœ… æ³¨å†ŒæˆåŠŸ'); }
        else { await signInWithEmailAndPassword(auth, email, password); showToast('âœ… ç™»å½•æˆåŠŸ'); }
        authModal.classList.remove('show'); setTimeout(()=>authModal.classList.add('hidden'),200); authForm.reset();
      }catch(error){
        let msg='è®¤è¯å¤±è´¥ï¼š';
        switch(error.code){
          case 'auth/invalid-email': msg+='é‚®ç®±æ ¼å¼æ— æ•ˆã€‚'; break;
          case 'auth/user-disabled': msg+='æ­¤ç”¨æˆ·å·²è¢«ç¦ç”¨ã€‚'; break;
          case 'auth/user-not-found':
          case 'auth/wrong-password': msg+='é‚®ç®±æˆ–å¯†ç é”™è¯¯ã€‚'; break;
          case 'auth/email-already-in-use': msg+='è¯¥é‚®ç®±å·²è¢«æ³¨å†Œã€‚è¯·åˆ‡æ¢åˆ°ç™»å½•æ¨¡å¼ã€‚'; break;
          default: msg+=error.message;
        }
        showError(msg);
      }finally{ modalSubmitBtn.disabled=false; modalSubmitBtn.textContent = authMode==='login'?'ç™»å½•':'æ³¨å†Œ'; }
    }
    async function handleSignOut(){ try{ await signOut(auth); showToast('ğŸ‘‹ å·²é€€å‡ºç™»å½•'); } catch(e){ console.error(e); showError('é€€å‡ºç™»å½•å¤±è´¥: '+e.message); } }
    authForm.addEventListener('submit', handleAuthSubmit);
    toggleModeBtn.addEventListener('click', toggleAuthMode);
    closeModalBtn.addEventListener('click', ()=>{ authModal.classList.remove('show'); setTimeout(()=>authModal.classList.add('hidden'),200); });
    authModal.addEventListener('click', (e)=>{ if(e.target===authModal){ authModal.classList.remove('show'); setTimeout(()=>authModal.classList.add('hidden'),200); } });

    // æœç´¢æ¡†
    searchInput.addEventListener('input', (e)=> filterAndRenderPrompts(e.target.value.toLowerCase()));

    // å¯åŠ¨
    initFirebase();
    // åˆå§‹ç”Ÿæˆ 3 ä¸ªå°é»„è±† + è‡ªé€‚åº”æ•°é‡
    spawnMascots(3);
    window.addEventListener('resize', ()=>{
      const w = window.innerWidth;
      const count = w>1400 ? 5 : (w>1024 ? 4 : 3);
      spawnMascots(count);
    });
  </script>
</body>
</html>
