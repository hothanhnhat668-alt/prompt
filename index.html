<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¥¥åˆ©ç»™ï¼Promptäº‘åŒæ­¥åº“</title>
  <meta name="theme-color" content="#4f46e5" />
  <link rel="manifest" href="manifest.json" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: {
        fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
        colors: { primary:'#4f46e5' }
      } }
    };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <!-- å¼•å…¥ Firebase æ¨¡å— - ä½¿ç”¨ compat ç‰ˆæœ¬ä»¥ä¾¿ä¸ç°æœ‰ä»£ç å…¼å®¹ -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>

  <style>
    :root { color-scheme: dark; }
    body{ font-family: Inter, ui-sans-serif, system-ui, -apple-system; }
    /* èƒŒæ™¯åŠ¨æ•ˆ */
    @keyframes blobFloat{0%{transform:translate3d(0,0,0) scale(1)}100%{transform:translate3d(3vw,-2vh,0) scale(1.06)}}

    /* ===== ä¿®å¤ä¸‹æ‹‰èœå•é€‰é¡¹åœ¨æ·±è‰²æ¨¡å¼ä¸‹çš„å¯è¯»æ€§é—®é¢˜ ===== */
    select option {
      color: #111827; /* è®¾ç½®ä¸ºæ·±è‰²æ–‡å­— */
      background: #FFFFFF; /* è®¾ç½®ä¸ºæµ…è‰²èƒŒæ™¯ */
    }
     /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.3); border-radius: 3px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }

    /* ç¡®ä¿ Prompt Card é«˜åº¦ä¸€è‡´ */
     .prompt-card {
        height: 200px; /* Or min-height if preferred */
        display: flex;
        flex-direction: column;
        justify-content: space-between;
     }
     .prompt-card-content {
         flex-grow: 1; /* Allow content to take up space */
         overflow: hidden; /* Hide overflow */
     }
     .prompt-card-summary {
         display: -webkit-box;
         -webkit-line-clamp: 3; /* Limit to 3 lines */
         -webkit-box-orient: vertical;
         overflow: hidden;
         text-overflow: ellipsis;
         min-height: 3.9em; /* Approx height for 3 lines */
         max-height: 3.9em;
     }

  </style>
</head>
<body class="min-h-screen text-white bg-gradient-to-b from-[#0b1220] via-[#0e1530] to-[#0b1220]">
  <div class="pointer-events-none fixed inset-0 -z-10">
    <div class="absolute inset-0" style="background:
      radial-gradient(1200px 800px at 10% 5%, rgba(31,41,55,1) 0%, rgba(31,41,55,0) 35%),
      radial-gradient(900px 700px at 85% 15%, rgba(55,48,163,0.35) 0%, rgba(55,48,163,0) 45%),
      radial-gradient(900px 700px at 20% 85%, rgba(16,185,129,0.25) 0%, rgba(16,185,129,0) 40%),
      linear-gradient(180deg,#0b1220 0%, #0f172a 45%, #111827 100%)
    "></div>
    <div class="absolute inset-0 opacity-20" style="background-image:
      linear-gradient(to right, rgba(255,255,255,.05) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(255,255,255,.05) 1px, transparent 1px);
      background-size:28px 28px;"></div>
    <div class="absolute w-[38vw] h-[38vw] max-w-[680px] max-h-[680px] rounded-full blur-[40px] opacity-70 mix-blend-multiply bg-gradient-to-br from-indigo-400 to-blue-400 animate-[blobFloat_16s_ease-in-out_infinite_alternate] -top-[10vh] -left-[10vw]"></div>
    <div class="absolute w-[38vw] h-[38vw] max-w-[680px] max-h-[680px] rounded-full blur-[40px] opacity-70 mix-blend-multiply bg-gradient-to-br from-amber-400 to-rose-500 animate-[blobFloat_16s_ease_in_out_infinite_alternate] top-[20vh] -right-[12vw]" style="animation-delay:.6s"></div>
    <div class="absolute w-[38vw] h-[38vw] max-w-[680px] max-h-[680px] rounded-full blur-[40px] opacity-70 mix-blend-multiply bg-gradient-to-br from-emerald-400 to-cyan-400 animate-[blobFloat_16s_ease_in_out_infinite_alternate] -bottom-[12vh] left-[20vw]" style="animation-delay:1.2s"></div>
  </div>

  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    // ---------------- å·¥å…· ----------------
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

    function autoSummarize(text){
      if(!text) return '';
      const clean = text.replace(/\s+/g,' ').trim();
      const first = clean.split(/[ã€‚.!?ï¼›;]\s*/)[0] || clean.slice(0,80);
      const words = clean.toLowerCase().match(/[\p{L}\p{N}_\-]{2,}/gu) || [];
      const stop = new Set(['the','and','for','with','that','this','you','your','æˆ‘ä»¬','ä»¥åŠ','çš„æ˜¯','å¯ä»¥','å¦‚ä½•','ä¸€ä¸ª','æç¤º','prompt','å†…å®¹']);
      const freq = {};
      words.forEach(w=>{ if(!stop.has(w)) freq[w]=(freq[w]||0)+1; });
      const top = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,4).map(x=>x[0]);
      let res = first;
      if(top.length) res += ' ï½œ å…³é”®è¯ï¼š' + top.join('ã€');
      return res.slice(0,84);
    }

    const SYNONYMS = {
      "å¤–è´¸": ["å›½é™…è´¸æ˜“","B2B","å‡ºå£","æµ·å…³","è´¸æ˜“"],
      "å®¢æˆ·å¼€å‘": ["è·å®¢","çº¿ç´¢","sales prospecting","å¼€å‘ä¿¡","è·Ÿè¿›"],
      "é‚®ä»¶": ["email","ç”µé‚®","é‚®ä»¶æ¨¡æ¿","é‚®ä»¶ä¸»é¢˜"],
      "å¤©çº¿": ["antenna","GPS","GNSS","4G","5G","LoRa","WiFi","å«æ˜Ÿ"],
      "è§†é¢‘": ["çŸ­è§†é¢‘","æŠ–éŸ³","å‰ªè¾‘","è„šæœ¬","åˆ†é•œ","TikTok"],
      "è‹±æ–‡": ["è‹±è¯­","English","å£è¯­","ç¿»è¯‘"],
      "æœç´¢": ["æŸ¥æ‰¾","æ£€ç´¢","è¯­ä¹‰","æ¨¡ç³ŠåŒ¹é…","ç›¸å…³æ€§"],
      "æ ‡ç­¾": ["tag","åˆ†ç±»","å½’æ¡£"]
    };
    function expandQuery(q){
      const bag = new Set([q]);
      Object.entries(SYNONYMS).forEach(([k,arr])=>{
        if(q.includes(k)) arr.forEach(s=>bag.add(s));
        if(arr.some(v=>q.includes(v))) bag.add(k);
      });
      return Array.from(bag);
    }

    // -------------- Firebase & Firestore è®¾ç½® --------------
    // !!! å·²ä»æ‚¨çš„å›¾ç‰‡ä¸­è·å–å¹¶æ›¿æ¢ !!!
    const firebaseConfig = {
      apiKey: "AIzaSyDirBHX8vyo3fnvvud2aq5-dsvjQT4iWps",
      authDomain: "prompt-4a7f5.firebaseapp.com",
      projectId: "prompt-4a7f5",
      storageBucket: "prompt-4a7f5.firebasestorage.app",
      messagingSenderId: "960214780733",
      appId: "1:960214780733:web:285f65cb27de2e042f9354",
      measurementId: "G-9G2DPCKG1V"
    };

    let app, auth, db, storage;
    let userId = null; // å…¨å±€ userId å˜é‡

    try {
      if (!firebase.apps.length) { // é˜²æ­¢é‡å¤åˆå§‹åŒ–
        app = firebase.initializeApp(firebaseConfig);
      } else {
        app = firebase.app();
      }
      auth = firebase.auth();
      db = firebase.firestore();
      storage = firebase.storage();
      firebase.firestore.setLogLevel('debug');
    } catch (e) {
      console.error("Firebase/Firestore åˆå§‹åŒ–å¤±è´¥ï¼šè¯·æ£€æŸ¥é…ç½®å’Œç½‘ç»œã€‚", e);
      alert("Firebase åˆå§‹åŒ–å¤±è´¥ï¼è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚");
    }

    // -------------- æ ¸å¿ƒæ•°æ® Hook (ä½¿ç”¨ Firestore) --------------
    function useCloudData(){
      const [projects, setProjects] = useState([]);
      const [prompts, setPrompts] = useState([]);
      const [loading, setLoading] = useState(true);

      // Firestore è·¯å¾„ç”Ÿæˆ - ç¡®ä¿ userId æœ‰æ•ˆ
      const getPath = (collectionName) => {
        if (!userId) {
          console.error("User ID not available for Firestore path.");
          return null;
        }
        return `artifacts/v1/users/${userId}/${collectionName}`;
      };

      // å®æ—¶ç›‘å¬å™¨
      useEffect(() => {
        if (!db || !userId) { // æ£€æŸ¥ userId
          console.log("Firestore hook waiting for userId...");
          setLoading(false); // æ²¡æœ‰ç”¨æˆ·IDï¼Œåœæ­¢åŠ è½½
          setProjects([]); // æ¸…ç©ºæ•°æ®
          setPrompts([]); // æ¸…ç©ºæ•°æ®
          return;
        }
        console.log("Firestore hook initializing with userId:", userId);
        setLoading(true);

        const projectPath = getPath('projects');
        const promptPath = getPath('prompts');
        if (!projectPath || !promptPath) return; // è·¯å¾„æ— æ•ˆåˆ™é€€å‡º

        let isMounted = true; // é˜²æ­¢ç»„ä»¶å¸è½½åæ›´æ–°çŠ¶æ€

        // 1. ç›‘å¬é¡¹ç›®
        const unsubscribeProjects = db.collection(projectPath).onSnapshot(snapshot => {
          if (!isMounted) return;
          const newProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

          // ç¡®ä¿æœ‰ä¸€ä¸ªé»˜è®¤é¡¹ç›® (ä»…å½“é¦–æ¬¡åŠ è½½ä¸”æ— æ•°æ®æ—¶)
          if (newProjects.length === 0 && snapshot.metadata.fromCache === false) {
             db.collection(projectPath).doc('default').set({ name: 'é»˜è®¤é¡¹ç›®', createdAt: firebase.firestore.FieldValue.serverTimestamp() })
                .catch(err => console.error("åˆ›å»ºé»˜è®¤é¡¹ç›®å¤±è´¥:", err));
          } else if (newProjects.length > 0 && !newProjects.find(p => p.id === 'default')) {
            // å¦‚æœå­˜åœ¨é¡¹ç›®ä½†æ²¡æœ‰é»˜è®¤é¡¹ç›®ï¼ˆå¯èƒ½è¢«åˆ é™¤äº†ï¼‰ï¼Œé‡æ–°æ£€æŸ¥å¹¶åˆ›å»º
             db.collection(projectPath).doc('default').get().then(doc => {
                 if (!doc.exists && isMounted) {
                    db.collection(projectPath).doc('default').set({ name: 'é»˜è®¤é¡¹ç›®', createdAt: firebase.firestore.FieldValue.serverTimestamp() })
                        .catch(err => console.error("é‡æ–°åˆ›å»ºé»˜è®¤é¡¹ç›®å¤±è´¥:", err));
                 }
             });
          }

          setProjects(newProjects.sort((a, b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0)));
        }, err => {
          if (isMounted) {
            console.error("é¡¹ç›®æ•°æ®ç›‘å¬å¤±è´¥:", err);
            setLoading(false);
          }
        });

        // 2. ç›‘å¬ Prompts
        const unsubscribePrompts = db.collection(promptPath).orderBy('createdAt', 'desc').onSnapshot(snapshot => {
          if (!isMounted) return;
          const newPrompts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          setPrompts(newPrompts);
          setLoading(false);
        }, err => {
           if (isMounted) {
            console.error("Prompt æ•°æ®ç›‘å¬å¤±è´¥:", err);
            setLoading(false);
           }
        });

        return () => {
          isMounted = false;
          console.log("Unsubscribing Firestore listeners for userId:", userId);
          unsubscribeProjects();
          unsubscribePrompts();
        };
      }, [userId]); // ä¾èµ– userId

      // --- CRUD æ“ä½œ --- (ç¡®ä¿æ‰€æœ‰æ“ä½œéƒ½æ£€æŸ¥ userId)

      const createProject = async (name) => {
        if (!name?.trim() || !userId) return;
        const path = getPath('projects');
        if (!path) return;
        try {
            await db.collection(path).add({ name: name.trim(), createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        } catch (error) {
            console.error("åˆ›å»ºé¡¹ç›®å¤±è´¥:", error);
            alert("åˆ›å»ºé¡¹ç›®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚");
        }
      };

      const createPrompt = async ({ title, content, projectId }) => {
        if (!title.trim() || !content.trim() || !userId) return;
        const path = getPath('prompts');
        if (!path) return;
        const summary = autoSummarize(content);
        try {
            await db.collection(path).add({
              title: title.trim(),
              content: content.trim(),
              projectId: projectId || null,
              favorite: false,
              summary: summary,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (error) {
            console.error("åˆ›å»º Prompt å¤±è´¥:", error);
            alert("åˆ›å»º Prompt å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚");
        }
      };

      const updatePrompt = async (id, patch) => {
        if (!id || !userId) return;
        const path = getPath('prompts');
        if (!path) return;
        const dataToUpdate = { ...patch };
        if (patch.content) {
          dataToUpdate.summary = autoSummarize(patch.content);
        }
        try {
            await db.collection(path).doc(id).update(dataToUpdate);
        } catch (error) {
            console.error("æ›´æ–° Prompt å¤±è´¥:", error);
            alert("æ›´æ–° Prompt å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚");
        }
      };

      const deletePrompt = async (id) => {
        if (!id || !userId) return;
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ª Prompt å—ï¼Ÿ')) return;
        const path = getPath('prompts');
        if (!path) return;
        try {
            await db.collection(path).doc(id).delete();
        } catch (error) {
            console.error("åˆ é™¤ Prompt å¤±è´¥:", error);
            alert("åˆ é™¤ Prompt å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚");
        }
      };

      const updateProject = async (id, patch) => {
          if (!id || !userId || id === 'default') return;
          const path = getPath('projects');
          if (!path) return;
          try {
            await db.collection(path).doc(id).update(patch);
          } catch (error) {
             console.error("æ›´æ–°é¡¹ç›®å¤±è´¥:", error);
             alert("æ›´æ–°é¡¹ç›®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚");
          }
      };

      const deleteProject = async (id) => {
        if (!id || !userId || id === 'default') return;
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿ\n\nï¼ˆé¡¹ç›®å†…çš„ Prompt å°†è¢«è‡ªåŠ¨ç§»åˆ°â€œæœªå½’æ¡£â€ã€‚ï¼‰')) return;

        const promptPath = getPath('prompts');
        const projectPath = getPath('projects');
        if (!promptPath || !projectPath) return;

        const batch = db.batch();
        try {
            // ä½¿ç”¨ get() æŸ¥è¯¢éœ€è¦ç§»åŠ¨çš„ prompts
            const promptsToMoveSnapshot = await db.collection(promptPath).where('projectId', '==', id).get();
            
            promptsToMoveSnapshot.forEach(doc => {
                const docRef = db.collection(promptPath).doc(doc.id);
                batch.update(docRef, { projectId: null });
            });
            
            // åˆ é™¤é¡¹ç›®
            const projectRef = db.collection(projectPath).doc(id);
            batch.delete(projectRef);

            await batch.commit();
        } catch (error) {
            console.error("åˆ é™¤é¡¹ç›®å¤±è´¥:", error);
            alert("åˆ é™¤é¡¹ç›®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚");
        }
      };

      return { projects, prompts, loading, createProject, createPrompt, updatePrompt, deletePrompt, updateProject, deleteProject };
    }

    // -------------- æ¸²æŸ“ç»„ä»¶ --------------
    const GlassCard = ({ children, className='' }) => (
      <div className={'rounded-2xl border border-white/20 bg-white/10 backdrop-blur-xl shadow-xl ' + className}>{children}</div>
    );

    const Badge = ({ children }) => (
      <span className="inline-block px-2 py-0.5 rounded-full text-xs bg-white/20 text-white/90 border border-white/30 whitespace-nowrap">{children}</span>
    );

    const IconButton = ({ title, onClick, children, disabled=false }) => (
      <button title={title} onClick={onClick} disabled={disabled}
        className="inline-flex items-center justify-center rounded-lg border border-white/10 bg-white/20 hover:bg-white/30 text-white/90 px-2.5 py-2 shadow-sm transition-transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
        {children}
      </button>
    );

    const PrimaryButton = ({ children, onClick, disabled }) => (
      <button onClick={onClick} disabled={disabled} className="px-4 py-2 rounded-xl bg-indigo-500/90 hover:bg-indigo-500 text-white font-semibold shadow-lg shadow-indigo-500/20 disabled:bg-gray-600/50 disabled:cursor-not-allowed">
        {children}
      </button>
    );

    // -------------- ä¸»åº”ç”¨ --------------
    function App(){
      // Auth çŠ¶æ€
      const [user, setUser] = useState(null);
      const [authReady, setAuthReady] = useState(false);
      const [showAuth, setShowAuth] = useState(false);
      const [authMode, setAuthMode] = useState('login'); // login | register | forgotPassword

      // æ•°æ®çŠ¶æ€ - ä»äº‘ç«¯è·å–
      const { projects, prompts, loading, createProject, createPrompt, updatePrompt, deletePrompt, updateProject, deleteProject } = useCloudData();

      // UI çŠ¶æ€
      const [selectedProjectId, setSelectedProjectId] = useState('all');
      const [search, setSearch] = useState('');
      const [sort, setSort] = useState('newest');
      const [showCreate, setShowCreate] = useState(false);
      const [editing, setEditing] = useState(null);
      const [detail, setDetail] = useState(null);
      const [suggestions, setSuggestions] = useState([]);

      // è®¤è¯ç›‘å¬å™¨
      useEffect(()=>{
        if(!auth || !db) {
          console.warn("Firebase Auth or DB not initialized.");
          setAuthReady(true);
          return;
        }

        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

        const unsub = auth.onAuthStateChanged(u=>{
          console.log("Auth state changed:", u ? u.uid : 'No user');
          setUser(u); // æ›´æ–° user state
          userId = u ? u.uid : null; // æ›´æ–°å…¨å±€ userId
          if (!u) {
             // å¦‚æœç”¨æˆ·æœªç™»å½•ï¼ˆåŒ…æ‹¬ signOut åï¼‰ï¼Œå°è¯•åŒ¿åç™»å½•
             console.log("Attempting anonymous sign-in...");
             auth.signInAnonymously().catch(error => {
                console.error("Anonymous sign-in failed after logout:", error);
             });
          }
          setAuthReady(true); // æ ‡å¿—è®¤è¯å·²å‡†å¤‡å°±ç»ª
        }, error => {
          console.error("Auth state listener error:", error);
          setAuthReady(true); // å³ä½¿å‡ºé”™ä¹Ÿè¦æ ‡è®°ä¸ºå°±ç»ª
        });
        return ()=>unsub && unsub();
      }, []); // ç©ºä¾èµ–æ•°ç»„ï¼Œåªè¿è¡Œä¸€æ¬¡

      // Fuse ç´¢å¼•
      const fuse = React.useMemo(()=>{
        return new Fuse(prompts, {
          includeScore:true, shouldSort:true, threshold:0.32,
          keys:[
            { name:'title', weight:0.5 },
            { name:'content', weight:0.45 },
            { name:'summary', weight:0.25 },
            { name:'projectName', getFn:(p)=> projects.find(x=>x.id===p.projectId)?.name || '', weight:0.1 }
          ]
        });
      }, [prompts, projects]);

      // è”æƒ³è¯
      useEffect(()=>{
        const q = search.trim(); if(!q) return setSuggestions([]);
        setSuggestions(expandQuery(q).slice(1,7));
      }, [search]);

      // è¿‡æ»¤æ’åº
      const filtered = useMemo(()=>{
        let data = prompts.slice(); // ä» state è·å–
        if(selectedProjectId==='favorites') data = data.filter(p=>p.favorite);
        else if(selectedProjectId==='unassigned') data = data.filter(p=>!p.projectId || p.projectId === null);
        else if(selectedProjectId!=='all') data = data.filter(p=>p.projectId===selectedProjectId);

        const term = search.trim().toLowerCase();
        if(term){
          const expanded = expandQuery(term).join(' ');
          const ids = new Set(fuse.search(expanded).map(r=>r.item.id));
          data = data.filter(p=>ids.has(p.id));
        }

        switch (sort) {
          case 'newest': data.sort((a,b)=>(b.createdAt?.toMillis()||0)-(a.createdAt?.toMillis()||0)); break;
          case 'oldest': data.sort((a,b)=>(a.createdAt?.toMillis()||0)-(b.createdAt?.toMillis()||0)); break;
          case 'title-az': data.sort((a,b)=>(a.title||'').localeCompare(b.title||'')); break;
          case 'title-za': data.sort((a,b)=>(b.title||'').localeCompare(a.title||'')); break;
        }
        return data;
      }, [prompts, selectedProjectId, search, sort, fuse, projects]); // æ·»åŠ  projects ä¾èµ–

      // ç»Ÿè®¡
      const countAll = prompts.length;
      const countFav = prompts.filter(p=>p.favorite).length;
      const countUnassigned = prompts.filter(p=>!p.projectId || p.projectId === null).length;

      // é¡¹ç›®é‡å‘½åä¸åˆ é™¤
      function handleRenameProject(id, oldName) {
        if (!user || user.isAnonymous) return alert("è¯·å…ˆä½¿ç”¨é‚®ç®±ç™»å½•ä»¥ç¼–è¾‘é¡¹ç›®ã€‚");
        const newName = prompt('è¯·è¾“å…¥æ–°çš„é¡¹ç›®åç§°ï¼š', oldName);
        if (newName && newName.trim() && newName.trim() !== oldName) {
          updateProject(id, { name: newName.trim() });
        }
      }
      function handleDeleteProject(id) {
         if (!user || user.isAnonymous) return alert("è¯·å…ˆä½¿ç”¨é‚®ç®±ç™»å½•ä»¥åˆ é™¤é¡¹ç›®ã€‚");
         deleteProject(id);
         if (selectedProjectId === id) setSelectedProjectId('all');
      }

      // å¯¼å…¥/å¯¼å‡º
      const handleExport = () => { /* ... (ä¿æŒä¸å˜ï¼Œä½†æ·»åŠ  user æ£€æŸ¥) ... */
          if (!user || user.isAnonymous) return alert("è¯·å…ˆä½¿ç”¨é‚®ç®±ç™»å½•ä»¥å¯¼å‡ºæ•°æ®ã€‚");
          const exportData = { /* ... */ };
          try { /* ... */ } catch (err) { /* ... */ }
      };
      const handleImportClick = () => { /* ... (ä¿æŒä¸å˜ï¼Œä½†æ·»åŠ  user æ£€æŸ¥) ... */
          if (!user || user.isAnonymous) return alert("è¯·å…ˆä½¿ç”¨é‚®ç®±ç™»å½•ä»¥å¯¼å…¥æ•°æ®ã€‚");
          document.getElementById('import-file-input').click();
      };
      const handleFileChange = (e) => { /* ... (ä¿æŒä¸å˜) ... */ };

      // è®¤è¯æ“ä½œ
      const handleSignOut = () => {
        if(confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿé€€å‡ºåå°†åˆ‡æ¢ä¸ºåŒ¿åç”¨æˆ·ã€‚')){
          auth.signOut(); // onAuthStateChanged ä¼šå¤„ç†åŒ¿åç™»å½•
        }
      };
      const handleNameChange = () => { /* ... (ä¿æŒä¸å˜ï¼Œä½†æ·»åŠ  user.isAnonymous æ£€æŸ¥) ... */
          if (!user || user.isAnonymous) return alert("è¯·å…ˆä½¿ç”¨é‚®ç®±ç™»å½•ä»¥ä¿®æ”¹ç”¨æˆ·åã€‚");
          const newName = prompt(/* ... */);
          /* ... */
      };
      const handleAvatarChange = (e) => { /* ... (ä¿æŒä¸å˜ï¼Œä½†æ·»åŠ  user.isAnonymous æ£€æŸ¥) ... */
          if (!user || user.isAnonymous) { e.target.value = null; return alert("è¯·å…ˆä½¿ç”¨é‚®ç®±ç™»å½•ä»¥ä¿®æ”¹å¤´åƒã€‚"); }
          /* ... */
      };

      const getCurrentAuthButton = () => {
        if (!authReady) return <button disabled className="px-3 py-1.5 rounded-lg bg-white/10 text-white/60 text-sm">åŠ è½½ä¸­...</button>;
        
        if (user && !user.isAnonymous) { // å·²ç™»å½•éåŒ¿åç”¨æˆ·
          const email = user.email || 'å·²ç™»å½•';
          const photoURL = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || email)}&background=random`;
          return (
            <div className="flex gap-2 items-center">
              <img src={photoURL} alt="å¤´åƒ" className="w-8 h-8 rounded-full" />
              <span className="text-xs text-white/70 hidden sm:inline truncate max-w-[150px]" title={email}>
                {user.displayName || email.split('@')[0]}
              </span>
              <button onClick={handleNameChange} title="ä¿®æ”¹ç”¨æˆ·å" className="px-3 py-1.5 rounded-lg bg-white/10 border border-white/20 text-sm hover:bg-white/20">âœï¸</button>
              <input type="file" accept="image/*" onChange={handleAvatarChange} className="hidden" id="avatarInput" />
              <label htmlFor="avatarInput" title="ä¿®æ”¹å¤´åƒ" className="px-3 py-1.5 rounded-lg bg-white/10 border border-white/20 text-sm hover:bg-white/20 cursor-pointer">ğŸ–¼ï¸</label>
              <button onClick={handleSignOut} title="é€€å‡ºç™»å½•" className="px-3 py-1.5 rounded-lg bg-rose-500/90 hover:bg-rose-600 border border-white/20 text-sm">é€€å‡º</button>
            </div>
          );
        }
        // æœªç™»å½•æˆ–åŒ¿åç”¨æˆ·
        return <button onClick={()=>{ setShowAuth(true); setAuthMode('login'); }} className="px-3 py-1.5 rounded-lg bg-indigo-500/90 hover:bg-indigo-500 text-sm">ç™»å½• / æ³¨å†Œ</button>;
      };


      return (
        <div className="relative">
          {/* é¡¶æ  */}
          <header className="sticky top-0 z-30 backdrop-blur-xl bg-white/5 border-b border-white/10">
            <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-4">
              <div className="flex items-center gap-3">
                <div className="w-8 h-8 rounded-xl bg-gradient-to-br from-indigo-400 to-fuchsia-500 shadow-lg" />
                <div className="font-semibold tracking-wide">å¥¥åˆ©ç»™ï¼Promptäº‘åŒæ­¥åº“</div>
                <div className="hidden sm:flex items-center gap-2 text-white/70">
                  <Badge>React</Badge>
                  <Badge>Firestore</Badge>
                  <Badge>å®æ—¶åŒæ­¥</Badge>
                </div>
              </div>
              <div className="ml-auto flex items-center gap-2">
                <button onClick={handleImportClick} className="px-3 py-1.5 rounded-lg bg-white/10 border border-white/20 text-sm hover:bg-white/20" disabled={!user || user?.isAnonymous}>å¯¼å…¥</button>
                <button onClick={handleExport} className="px-3 py-1.5 rounded-lg bg-white/10 border border-white/20 text-sm hover:bg-white/20" disabled={!user || user?.isAnonymous}>å¯¼å‡º</button>

                {getCurrentAuthButton()}
                <PrimaryButton onClick={()=>{ if (!user) { setShowAuth(true); setAuthMode('login'); return; } setShowCreate(true); }} disabled={!authReady}>æ–°å»º Prompt</PrimaryButton> {/* ç¡®ä¿ authReady */}
              </div>
            </div>
          </header>

          {/* ä¸»ä½“ */}
          <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-[270px,1fr] gap-4 px-4 py-6">
            {/* ä¾§è¾¹æ  */}
            <GlassCard className="p-4 lg:h-[calc(100vh-120px)] lg:sticky lg:top-[84px] overflow-y-auto custom-scroll">
              <h2 className="text-lg font-semibold mb-3">é¡¹ç›® / è§†å›¾</h2>

              <nav className="space-y-2">
                <SidebarItem active={selectedProjectId==='all'} label="å…¨éƒ¨" count={countAll} onClick={()=>setSelectedProjectId('all')} />
                <SidebarItem active={selectedProjectId==='favorites'} label="â¤ï¸ æˆ‘çš„æ”¶è—" count={countFav} onClick={()=>setSelectedProjectId('favorites')} />
                <SidebarItem active={selectedProjectId==='unassigned'} label="æœªå½’æ¡£" count={countUnassigned} onClick={()=>setSelectedProjectId('unassigned')} />
                <div className="h-px bg-white/10 my-2" />
                <div className="flex items-center justify-between mb-1 text-sm text-white/70">
                  <span>é¡¹ç›®</span>
                  <button onClick={()=>{ if(!user || user.isAnonymous) return alert('è¯·å…ˆä½¿ç”¨é‚®ç®±ç™»å½•å†åˆ›å»ºé¡¹ç›®ã€‚'); const n=prompt('æ–°é¡¹ç›®åç§°'); if(n) createProject(n); }} className="text-indigo-300 hover:text-indigo-200">+ æ–°å»º</button>
                </div>

                {/* åŠ¨æ€é¡¹ç›®åˆ—è¡¨ */}
                <div className="space-y-1">
                  {projects.filter(p=>p.id!=='default').map(p=> (
                    <div
                      key={p.id}
                      className={
                        'group w-full flex items-center justify-between px-3 py-2 rounded-xl transition border ' +
                        (selectedProjectId === p.id
                          ? 'bg-indigo-400/20 border-indigo-300/30'
                          : 'bg-white/5 border-white/10 hover:bg-white/10')
                      }
                    >
                      <button
                        onClick={()=>setSelectedProjectId(p.id)}
                        className={'flex-1 truncate text-left ' + (selectedProjectId === p.id ? 'text-white' : 'text-white/85')}
                        title={p.name||'æœªå‘½åé¡¹ç›®'}
                      >
                        {p.name||'æœªå‘½åé¡¹ç›®'}
                      </button>
                      <span className="text-xs text-white/70 ml-2 flex-shrink-0">{prompts.filter(x=>x.projectId===p.id).length}</span>

                      {/* ç¼–è¾‘/åˆ é™¤æŒ‰é’® (æ‚¬åœæ˜¾ç¤º) */}
                      <div className="flex-shrink-0 flex gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity ml-1">
                         <IconButton title="é‡å‘½å" onClick={() => handleRenameProject(p.id, p.name)} disabled={!user || user?.isAnonymous}>âœï¸</IconButton>
                         <IconButton title="åˆ é™¤" onClick={() => handleDeleteProject(p.id)} disabled={!user || user?.isAnonymous}>ğŸ—‘ï¸</IconButton>
                      </div>
                    </div>
                  ))}
                  {/* Default Project */}
                  {projects.find(p => p.id === 'default') && (
                    <SidebarItem active={selectedProjectId==='default'} label={projects.find(p => p.id === 'default')?.name || 'é»˜è®¤é¡¹ç›®'} count={prompts.filter(x=>x.projectId==='default').length} onClick={()=>setSelectedProjectId('default')} />
                  )}
                </div>
              </nav>
            </GlassCard>

            {/* å†…å®¹åŒº */}
            {!authReady && <div className="col-span-1 lg:col-span-1 text-center py-20 text-white/50">æ­£åœ¨è¿æ¥äº‘ç«¯...</div>}
            {authReady && loading && <div className="col-span-1 lg:col-span-1 text-center py-20 text-white/50">åŠ è½½äº‘ç«¯æ•°æ®ä¸­...</div>}

            {authReady && !loading && (
              <div className="space-y-4">
                <GlassCard className="p-4">
                  <div className="flex flex-col md:flex-row gap-3 md:items-center">
                    <div className="flex-1">
                      <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="è¾“å…¥å…³é”®è¯æˆ–è‡ªç„¶è¯­è¨€ï¼ˆæ”¯æŒæ¨¡ç³Š/è¯­ä¹‰è”æƒ³ï¼‰..." className="w-full rounded-xl bg-white/10 border border-white/20 px-4 py-2.5 placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-indigo-400/50" />
                      {suggestions.length>0 && (
                        <div className="mt-2 flex flex-wrap gap-2">
                          {suggestions.map(s=> (
                            <button key={s} onClick={()=>setSearch(v=>(v+' '+s).trim())} className="text-xs px-2 py-1 rounded-full bg-indigo-400/15 text-indigo-200 border border-indigo-300/20 hover:bg-indigo-400/25">{s}</button>
                          ))}
                        </div>
                      )}
                    </div>
                    <select value={sort} onChange={e=>setSort(e.target.value)} className="md:w-52 rounded-xl bg-white/10 border border-white/20 px-3 py-2 focus:outline-none">
                      <option value="newest">æŒ‰æœ€æ–°åˆ›å»º</option>
                      <option value="oldest">æŒ‰æœ€æ—§åˆ›å»º</option>
                      <option value="title-az">æŒ‰æ ‡é¢˜ (A-Z)</option>
                      <option value="title-za">æŒ‰æ ‡é¢˜ (Z-A)</option>
                    </select>
                  </div>
                </GlassCard>

                {filtered.length===0
                  ? <EmptyState onCreate={()=>{ if (!user) { setShowAuth(true); setAuthMode('login'); return; } setShowCreate(true); }} />
                  : <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                      {filtered.map(p=> (
                        <PromptCard
                          key={p.id}
                          prompt={p}
                          projectName={projects.find(x=>x.id===p.projectId)?.name}
                          onOpen={()=>setDetail(p)}
                          onToggleFav={()=>updatePrompt(p.id, { favorite: !p.favorite })}
                          onCopy={()=>navigator.clipboard.writeText(p.content||'')}
                          onDelete={()=>deletePrompt(p.id)}
                          userLoggedIn={!!user && !user.isAnonymous} // ä»…å¯¹éåŒ¿åç”¨æˆ·æ˜¾ç¤º
                        />
                      ))}
                    </div>
                }
              </div>
            )}
          </div>

          {/* ç™»å½•å¼¹çª— */}
          {showAuth && (
            <Modal title={authMode==='login' ? 'ç”¨æˆ·ç™»å½•' : 'ç”¨æˆ·æ³¨å†Œ'} onClose={()=>{ setShowAuth(false); setAuthMode('login'); }}> {/* Reset mode on close */}
              <AuthForm mode={authMode} onToggle={()=>setAuthMode(m=> m==='login' ? 'register' : 'login')} />
            </Modal>
          )}

          {/* åˆ›å»º/è¯¦æƒ…/ç¼–è¾‘å¼¹çª— */}
          {showCreate && (
            <Modal title="æ–°å»º Prompt" onClose={()=>setShowCreate(false)}>
              <PromptEditor projects={projects} onSubmit={(data)=>{ if(data){ createPrompt(data); } setShowCreate(false); }} />
            </Modal>
          )}
          {detail && (
            <Modal title={detail.title||'(æœªå‘½å)'} onClose={()=>setDetail(null)}>
              <PromptDetailView
                detail={detail}
                projectName={projects.find(x=>x.id===detail.projectId)?.name}
                onClose={()=>setDetail(null)}
                onEdit={()=>{ setDetail(null); setEditing(detail); }} // å…³é—­è¯¦æƒ…ï¼Œæ‰“å¼€ç¼–è¾‘
                onDelete={()=> { deletePrompt(detail.id); setDetail(null); }}
                onToggleFav={()=>updatePrompt(detail.id, { favorite: !detail.favorite })}
                userLoggedIn={!!user && !user.isAnonymous} // ä»…å¯¹éåŒ¿åç”¨æˆ·æ˜¾ç¤º
              />
            </Modal>
          )}
          {editing && (
            <Modal title="ç¼–è¾‘ Prompt" onClose={()=>setEditing(null)}>
              <PromptEditor
                projects={projects}
                initial={{ title: editing.title, content: editing.content, projectId: editing.projectId || '' }}
                onSubmit={(data)=>{ if(data){ updatePrompt(editing.id, data); } setEditing(null); }}
              />
            </Modal>
          )}

          {/* æ–‡ä»¶å¯¼å…¥ input */}
          <input
            type="file"
            id="import-file-input"
            className="hidden"
            accept=".json"
            onChange={handleFileChange}
          />
        </div>
      );
    }

    const SidebarItem = ({ active, onClick, label, count }) => (
      <button onClick={onClick}
        className={'w-full flex items-center justify-between px-3 py-2 rounded-xl transition border ' + (active ? 'bg-indigo-400/20 border-indigo-300/30 text-white' : 'bg-white/5 border-white/10 text-white/85 hover:bg-white/10')}>
        <span className="truncate text-left">{label}</span>
        <span className="text-xs text-white/70">{count >= 0 ? count : '-'}</span> {/* æ˜¾ç¤º count */}
      </button>
    );

    const PromptCard = ({ prompt, projectName, onOpen, onToggleFav, onCopy, onDelete, userLoggedIn }) => (
      <div className="prompt-card group relative rounded-2xl border border-white/15 bg-white/10 backdrop-blur-xl p-4 shadow-lg hover:shadow-indigo-600/20 transition-transform hover:-translate-y-0.5">
        <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition">
          <IconButton title="å¤åˆ¶" onClick={(e)=>{ e.stopPropagation(); onCopy(); }}>ğŸ“‹</IconButton>
          {userLoggedIn && <IconButton title="æ”¶è—" onClick={(e)=>{ e.stopPropagation(); onToggleFav(); }}>{prompt.favorite ? 'ğŸ’›' : 'â­'}</IconButton>}
        </div>
        <div className="prompt-card-content"> {/* æ–°å¢å®¹å™¨ */}
            <div className="text-base font-semibold truncate mb-2 pr-12">{prompt.title||'(æœªå‘½å)'}</div>
            <div className="prompt-card-summary text-sm text-white/80">{prompt.summary || autoSummarize(prompt.content||'')}</div> {/* åº”ç”¨æˆªæ–­æ ·å¼ */}
        </div>
        <div className="mt-3 flex flex-col">
            <div className="flex items-center justify-between text-xs text-white/60 mb-2">
              <span>{prompt.createdAt?.toDate ? prompt.createdAt.toDate().toLocaleDateString() : 'æ— æ—¥æœŸ'}</span>
              <span className="truncate max-w-[50%]">{projectName? <Badge>{projectName}</Badge> : <Badge>æœªå½’æ¡£</Badge>}</span>
            </div>
            <div className='flex gap-2'>
              <button onClick={onOpen} className="flex-1 rounded-lg bg-white/10 hover:bg-white/20 border border-white/15 px-3 py-2 text-sm">æŸ¥çœ‹è¯¦æƒ…</button>
              {userLoggedIn && <IconButton title="åˆ é™¤" onClick={(e)=>{ e.stopPropagation(); onDelete(); }}>ğŸ—‘ï¸</IconButton>}
            </div>
        </div>
      </div>
    );

    function PromptDetailView({ detail, projectName, onClose, onEdit, onDelete, onToggleFav, userLoggedIn }) {
      return (
        <div className="space-y-4">
          <div className="max-h-[60vh] overflow-y-auto space-y-4 pr-2 custom-scroll">
            <div className="text-xl font-bold text-white mb-2">{detail.title}</div>
            <div className="flex flex-wrap gap-2 mb-3">
              <Badge>{projectName ? projectName : 'æœªå½’æ¡£'}</Badge>
              <Badge>{detail.createdAt?.toDate ? detail.createdAt.toDate().toLocaleString() : 'æ— æ—¥æœŸ'}</Badge>
            </div>
            <pre className="whitespace-pre-wrap text-sm leading-relaxed text-white/90 bg-white/10 border border-white/15 rounded-lg p-3 ">{detail.content}</pre>
          </div>
          <div className="flex justify-between items-center pt-4 border-t border-white/10">
            <div className='flex gap-2'>
              <PrimaryButton onClick={()=>navigator.clipboard.writeText(detail.content||'')}>ğŸ“‹ å¤åˆ¶ Prompt</PrimaryButton>
              {userLoggedIn && <IconButton title="æ”¶è—" onClick={onToggleFav}>{detail.favorite ? 'ğŸ’›' : 'â­'}</IconButton>}
            </div>
            <div className='flex gap-2'>
              {userLoggedIn && <IconButton title="ç¼–è¾‘" onClick={onEdit}>âœï¸</IconButton>}
              {userLoggedIn && <IconButton title="åˆ é™¤" onClick={onDelete}>ğŸ—‘ï¸</IconButton>}
              <button onClick={onClose} className="px-4 py-2 rounded-xl bg-white/10 border border-white/20 text-sm hover:bg-white/20">å…³é—­</button>
            </div>
          </div>
        </div>
      );
    }

    const EmptyState = ({ onCreate }) => (
      <GlassCard className="p-10 text-center">
        <div className="text-4xl mb-2">ğŸ§ª</div>
        <div className="text-lg mb-2">è¿˜æ²¡æœ‰ä»»ä½• Prompt</div>
        <div className="text-white/70 mb-4">ä»â€œæ–°å»º Promptâ€å¼€å§‹ï¼Œæˆ–åœ¨ä¸Šæ–¹æœç´¢æ¡†å°è¯•è¾“å…¥â€œå¤–è´¸ å®¢æˆ·å¼€å‘ å¤©çº¿â€ã€‚</div>
        <PrimaryButton onClick={onCreate}>æ–°å»º Prompt</PrimaryButton>
      </GlassCard>
    );

    function PromptEditor({ projects, initial, onSubmit }){
      const [title, setTitle] = useState(initial?.title||'');
      const [content, setContent] = useState(initial?.content||'');
      const [projectId, setProjectId] = useState(initial?.projectId||''); // é»˜è®¤æœªå½’æ¡£
      const [summary, setSummary] = useState(()=> autoSummarize(initial?.content||''));
      useEffect(()=>{ setSummary(autoSummarize(content)); }, [content]);

      function submit(e){
          e.preventDefault();
          if(!title.trim() || !content.trim()) return;
          onSubmit({
              title:title.trim(),
              content:content.trim(),
              projectId:projectId||null,
              summary:summary.trim()||autoSummarize(content)
          });
      }
      return (
        <form onSubmit={submit} className="space-y-3">
          <div>
            <label className="block text-sm mb-1">æ ‡é¢˜</label>
            <input value={title} onChange={e=>setTitle(e.target.value)} className="w-full rounded-xl bg-white/10 border border-white/20 px-3 py-2 focus:outline-none" placeholder="è¾“å…¥ç®€çŸ­æ ‡é¢˜" required />
          </div>
          <div>
            <label className="block text-sm mb-1">å½’å±é¡¹ç›®</label>
            <select value={projectId || ''} onChange={e=>setProjectId(e.target.value)} className="w-full rounded-xl bg-white/10 border border-white/20 px-3 py-2 focus:outline-none">
              <option value="">æœªå½’æ¡£</option>
              {/* ç¡®ä¿ projects æ•°ç»„å­˜åœ¨ */}
              {projects?.map(p=> <option key={p.id} value={p.id}>{p.name}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm mb-1">Prompt å†…å®¹</label>
            <textarea value={content} onChange={e=>setContent(e.target.value)} rows="6" className="w-full rounded-xl bg-white/10 border border-white/20 px-3 py-2 focus:outline-none custom-scroll" placeholder="è¾“å…¥å®Œæ•´çš„ Prompt æ–‡æœ¬..." required></textarea>
          </div>
          <div>
            <label className="block text-sm mb-1">è‡ªåŠ¨æ‘˜è¦ï¼ˆå¯æ‰‹åŠ¨ä¿®æ”¹ï¼‰</label>
            <input value={summary} onChange={e=>setSummary(e.target.value)} className="w-full rounded-xl bg-white/10 border border-white/20 px-3 py-2 focus:outline-none" placeholder="ç³»ç»Ÿå°†åŸºäºå†…å®¹è‡ªåŠ¨ç”Ÿæˆ" />
          </div>
          <div className="pt-2 flex items-center justify-end gap-2">
            <button type="button" onClick={()=>onSubmit(null)} className="px-4 py-2 rounded-xl bg-white/10 border border-white/20">å–æ¶ˆ</button>
            <PrimaryButton type="submit">ä¿å­˜</PrimaryButton>
          </div>
        </form>
      );
    }

    const Modal = ({ title, children, onClose }) => (
      <div className="fixed inset-0 z-40 grid place-items-center bg-black/40 p-4 backdrop-blur-sm" onClick={onClose}>
        <div className="w-full max-w-2xl rounded-2xl border border-white/20 bg-[#0e1530]/95 backdrop-blur-xl p-5 shadow-2xl" onClick={(e)=>e.stopPropagation()}>
          <div className="flex items-center justify-between mb-3">
            <div className="text-lg font-semibold">{title}</div>
            <button onClick={onClose} className="text-white/70 hover:text-white">âœ•</button>
          </div>
          {children}
        </div>
      </div>
    );

    // ç™»å½•/æ³¨å†Œ/å¿˜è®°å¯†ç è¡¨å•
    function AuthForm({ mode: initialMode, onToggle, onClose }){ // æ¥æ”¶ onClose
      const [mode, setMode] = useState(initialMode);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [message, setMessage] = useState(''); // ç”¨äºæ˜¾ç¤ºé‡ç½®å¯†ç æˆåŠŸä¿¡æ¯

      const handleResetPassword = async () => {
         if(!email) { setError('è¯·è¾“å…¥é‚®ç®±åœ°å€åç‚¹å‡»å¿˜è®°å¯†ç ã€‚'); return; }
         setMessage(''); // æ¸…é™¤æ—§æ¶ˆæ¯
         setError(''); // æ¸…é™¤æ—§é”™è¯¯
         try {
            await auth.sendPasswordResetEmail(email);
            setMessage('å¯†ç é‡ç½®é‚®ä»¶å·²å‘é€åˆ°æ‚¨çš„é‚®ç®±ï¼Œè¯·æŸ¥æ”¶ã€‚');
         } catch (err) {
            setError(err.message || 'å‘é€å¤±è´¥');
         }
      };

      async function submit(e){
        e.preventDefault(); setError(''); setMessage('');
        if(!auth){ setError('æœªå¯ç”¨ Firebaseã€‚è¯·åœ¨ index.html ä¸­å¡«å…¥ firebaseConfigã€‚'); return; }
        try{
          if(mode==='login'){ await auth.signInWithEmailAndPassword(email, password); }
          else { await auth.createUserWithEmailAndPassword(email, password); }
          onClose(); // ç™»å½•/æ³¨å†ŒæˆåŠŸåå…³é—­æ¨¡æ€æ¡†
        } catch(err){
           // ä¼˜åŒ–é”™è¯¯æç¤º
           let friendlyError = err.message || 'æ“ä½œå¤±è´¥';
           if (err.code === 'auth/invalid-email') friendlyError = 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®ã€‚';
           if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') friendlyError = 'é‚®ç®±æˆ–å¯†ç é”™è¯¯ã€‚';
           if (err.code === 'auth/email-already-in-use') friendlyError = 'è¯¥é‚®ç®±å·²è¢«æ³¨å†Œï¼Œè¯·å°è¯•ç™»å½•ã€‚';
           if (err.code === 'auth/weak-password') friendlyError = 'å¯†ç å¼ºåº¦ä¸è¶³ï¼Œè¯·è‡³å°‘ä½¿ç”¨6ä½å­—ç¬¦ã€‚';
           setError(friendlyError);
        }
      }

      return (
        <form onSubmit={submit} className="space-y-3">
          {mode !== 'forgotPassword' && (
            <>
              <div>
                <label className="block text-sm mb-1">é‚®ç®±</label>
                <input value={email} onChange={e=>setEmail(e.target.value)} type="email" required className="w-full rounded-xl bg-white/10 border border-white/20 px-3 py-2 focus:outline-none" placeholder="you@example.com" />
              </div>
              <div>
                <label className="block text-sm mb-1">å¯†ç </label>
                <input value={password} onChange={e=>setPassword(e.target.value)} type="password" minLength="6" required className="w-full rounded-xl bg-white/10 border border-white/20 px-3 py-2 focus:outline-none" placeholder="è‡³å°‘6ä½" />
              </div>
            </>
          )}
          {mode === 'forgotPassword' && (
             <div>
                <label className="block text-sm mb-1">è¯·è¾“å…¥æ‚¨çš„æ³¨å†Œé‚®ç®±</label>
                <input value={email} onChange={e=>setEmail(e.target.value)} type="email" required className="w-full rounded-xl bg-white/10 border border-white/20 px-3 py-2 focus:outline-none" placeholder="you@example.com" />
             </div>
          )}

          {error && <div className="text-sm text-rose-300">{error}</div>}
          {message && <div className="text-sm text-emerald-300">{message}</div>}

          <div className="flex flex-col pt-2 gap-2">
            {mode !== 'forgotPassword' && (
              <PrimaryButton type="submit">{mode==='login'?'ç™»å½•':'æ³¨å†Œ'}</PrimaryButton>
            )}
            {mode === 'login' && (
              <button type='button' onClick={()=>setMode('forgotPassword')} className="text-xs text-white/50 hover:text-white/80">å¿˜è®°å¯†ç ï¼Ÿ</button>
            )}
             {mode === 'forgotPassword' && (
               <PrimaryButton type='button' onClick={handleResetPassword}>å‘é€é‡ç½®é‚®ä»¶</PrimaryButton>
            )}
            <button type="button" onClick={() => setMode(m => m === 'login' ? 'register' : 'login')} className="text-indigo-300 hover:text-indigo-200 text-sm">
              {mode === 'login' ? 'æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ' : (mode === 'register' ? 'å·²æœ‰è´¦å·ï¼Ÿç‚¹å‡»ç™»å½•' : 'è¿”å›ç™»å½•')}
            </button>
          </div>
        </form>
      );
    }


    // æ¸²æŸ“
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

    // Service Worker æ³¨å†Œ (ä¿æŒä¸å˜)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(registration => console.log('SW registered: ', registration))
          .catch(registrationError => console.log('SW registration failed: ', registrationError));
      });
    }
  </script>
</body>
</html>

